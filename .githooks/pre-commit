#!/bin/bash

# Pre-commit hook to ensure code quality and process images
# This hook will:
# 1. Run code quality checks (prettier, eslint, typescript)
# 2. Check if there are changes in public/images/
# 3. Update gallery.json if new creatures series are found
# 4. Optimize images (create WebP versions)
# 5. Stage the updated files

echo "ğŸ” Pre-commit hook: Running quality checks..."
echo ""

# Check if there are any staged TypeScript/JavaScript files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$')

if [ -n "$STAGED_FILES" ]; then
  echo "ğŸ“ Running Prettier..."
  npm run format:check
  if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ Prettier formatting failed!"
    echo "ğŸ’¡ Run 'npm run format' to fix formatting issues, then commit again."
    exit 1
  fi
  echo "âœ… Prettier check passed"
  echo ""

  echo "ğŸ” Running ESLint..."
  npm run lint
  if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ ESLint failed!"
    echo "ğŸ’¡ Fix linting errors before committing."
    exit 1
  fi
  echo "âœ… ESLint passed"
  echo ""

  echo "ğŸ”§ Running TypeScript type check..."
  npm run type-check
  if [ $? -ne 0 ]; then
    echo ""
    echo "âŒ TypeScript type check failed!"
    echo "ğŸ’¡ Fix type errors before committing."
    exit 1
  fi
  echo "âœ… TypeScript check passed"
  echo ""
else
  echo "â„¹ï¸  No code files to check, skipping quality checks..."
  echo ""
fi

echo "ğŸ” Checking for image changes..."

# Check if there are changes in public/images/
if git diff --cached --name-only | grep -q "^public/images/"; then
  echo "ğŸ“¸ Changes detected in public/images/"

  # Check specifically for new creatures folders
  NEW_CREATURES=$(git diff --cached --name-only | grep -E "^public/images/creatures/creatures[0-9]+/" | sed 's|/.*||' | sort -u)

  if [ -n "$NEW_CREATURES" ]; then
    echo "ğŸ†• New creatures series detected!"
    echo ""

    # Update gallery.json with new creatures series
    echo "ğŸ“ Updating gallery.json..."
    node scripts/update-gallery-data.js
    GALLERY_UPDATED=$?

    if [ $GALLERY_UPDATED -eq 0 ]; then
      echo ""
      echo "ğŸ¨ Optimizing images (creating WebP versions)..."
      npm run optimize:images

      echo ""
      echo "â• Staging updated files..."

      # Stage gallery.json if it was updated
      git add src/data/gallery.json

      # Stage all newly created WebP files
      git add public/images/**/*.webp

      echo "âœ… Image processing complete!"
      echo ""
      echo "ğŸ“‹ Summary:"
      echo "  - gallery.json updated with new creatures series"
      echo "  - Images optimized (WebP versions created)"
      echo "  - All changes staged for commit"
      echo ""
    else
      echo "â„¹ï¸  No new creatures series to add, but optimizing any new images..."
      npm run optimize:images
      git add public/images/**/*.webp
    fi
  else
    echo "ğŸ–¼ï¸  Image changes detected (not new creatures series)"
    echo "ğŸ¨ Optimizing images..."
    npm run optimize:images
    git add public/images/**/*.webp
  fi
else
  echo "âœ“ No image changes detected, proceeding with commit..."
fi

exit 0
